# PlanningAgent ä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

PlanningAgentæ˜¯ä¸€ä¸ªå…·å¤‡ä»»åŠ¡è§„åˆ’å’Œç®¡ç†èƒ½åŠ›çš„æ™ºèƒ½Agentï¼Œèƒ½å¤Ÿå°†å¤æ‚ä»»åŠ¡åˆ†è§£ä¸ºå¯æ‰§è¡Œçš„å­ä»»åŠ¡ï¼Œå¹¶æ ¹æ®ä¾èµ–å…³ç³»å’Œä¼˜å…ˆçº§è¿›è¡Œè°ƒåº¦æ‰§è¡Œã€‚

## æ ¸å¿ƒèƒ½åŠ›

### 1. ä»»åŠ¡åˆ†è§£
- å°†ç”¨æˆ·çš„å¤æ‚éœ€æ±‚åˆ†è§£ä¸ºå…·ä½“ã€å¯æ‰§è¡Œçš„å­ä»»åŠ¡
- æ¯ä¸ªå­ä»»åŠ¡éƒ½æœ‰æ¸…æ™°çš„æ ‡é¢˜å’Œæè¿°
- è‡ªåŠ¨è¯†åˆ«ä»»åŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»

### 2. ä»»åŠ¡è°ƒåº¦
- æ ¹æ®ä»»åŠ¡ä¼˜å…ˆçº§æ’åºï¼šCRITICAL > HIGH > MEDIUM > LOW
- éµå¾ªä»»åŠ¡ä¾èµ–å…³ç³»ï¼Œç¡®ä¿å‰ç½®ä»»åŠ¡å®Œæˆåæ‰æ‰§è¡Œåç»­ä»»åŠ¡
- æ”¯æŒä»»åŠ¡çŠ¶æ€ç®¡ç†ï¼šPENDINGã€IN_PROGRESSã€COMPLETEDã€FAILEDã€BLOCKED

### 3. è¿›åº¦è·Ÿè¸ª
- å®æ—¶è·Ÿè¸ªæ¯ä¸ªä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€
- æä¾›æ•´ä½“è¿›åº¦ç»Ÿè®¡ï¼ˆæ€»æ•°ã€å·²å®Œæˆã€è¿›è¡Œä¸­ã€å¤±è´¥ç­‰ï¼‰
- é€šè¿‡WebSocketæ¨é€æ‰§è¡Œè¿›åº¦æ›´æ–°

### 4. AgentååŒ
- å¯ä»¥å°†ä»»åŠ¡å§”æ‰˜ç»™å…¶ä»–ä¸“ä¸šAgentæ‰§è¡Œ
- æ”¯æŒä¸"é€šç”¨åŠ©ç†"ã€"åˆ†æä¸“å®¶"ã€"ç¼–ç¨‹åŠ©æ‰‹"ç­‰AgentååŒå·¥ä½œ
- è‡ªåŠ¨æ•´åˆå„Agentçš„æ‰§è¡Œç»“æœ

## ä½¿ç”¨æ–¹å¼

### æ–¹å¼1: WebSocket (æ¨è)

```javascript
// è¿æ¥WebSocket
const ws = new WebSocket('ws://localhost:8000/ws/my_session');

ws.onopen = () => {
    // å‘é€ä»»åŠ¡è§„åˆ’è¯·æ±‚
    ws.send(JSON.stringify({
        type: 'message',
        mode: 'agent',
        agent_name: 'ä»»åŠ¡è§„åˆ’å¸ˆ',
        content: 'å¸®æˆ‘è§„åˆ’ä¸€ä¸ªWebåº”ç”¨å¼€å‘é¡¹ç›®'
    }));
};

ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    
    switch(data.type) {
        case 'planning_start':
            console.log('å¼€å§‹è§„åˆ’ä»»åŠ¡...');
            break;
            
        case 'planning_tasks':
            console.log('ä»»åŠ¡è®¡åˆ’:', data.tasks);
            console.log('è¿›åº¦:', data.progress);
            break;
            
        case 'planning_task_start':
            console.log('å¼€å§‹æ‰§è¡Œä»»åŠ¡:', data.task.title);
            break;
            
        case 'planning_task_complete':
            console.log('ä»»åŠ¡å®Œæˆ:', data.task.title);
            break;
            
        case 'planning_progress':
            console.log('è¿›åº¦æ›´æ–°:', data.progress);
            break;
    }
};
```

### æ–¹å¼2: HTTP API

```bash
# æŸ¥çœ‹PlanningAgentä¿¡æ¯
curl http://localhost:8000/agent/info | jq '.[] | select(.name=="ä»»åŠ¡è§„åˆ’å¸ˆ")'

# åˆ‡æ¢åˆ°PlanningAgent
curl -X POST "http://localhost:8000/agent/switch/my_session?agent_name=ä»»åŠ¡è§„åˆ’å¸ˆ"
```

## ç¤ºä¾‹åœºæ™¯

### åœºæ™¯1: Webåº”ç”¨å¼€å‘è§„åˆ’

**ç”¨æˆ·è¾“å…¥:**
```
å¸®æˆ‘è§„åˆ’ä¸€ä¸ªç”µå•†ç½‘ç«™çš„å¼€å‘ä»»åŠ¡ï¼Œéœ€è¦åŒ…å«ç”¨æˆ·ç³»ç»Ÿã€å•†å“ç®¡ç†ã€è®¢å•å¤„ç†ç­‰åŠŸèƒ½
```

**PlanningAgentä¼š:**
1. åˆ†æéœ€æ±‚ï¼Œè¯†åˆ«æ ¸å¿ƒåŠŸèƒ½æ¨¡å—
2. åˆ†è§£ä¸ºå…·ä½“ä»»åŠ¡ï¼ˆéœ€æ±‚åˆ†æã€æŠ€æœ¯é€‰å‹ã€æ¶æ„è®¾è®¡ã€åŠŸèƒ½å®ç°ã€æµ‹è¯•ç­‰ï¼‰
3. è®¾ç½®ä»»åŠ¡ä¼˜å…ˆçº§å’Œä¾èµ–å…³ç³»
4. æŒ‰é¡ºåºæ‰§è¡Œä»»åŠ¡ï¼Œå§”æ‰˜ç»™åˆé€‚çš„Agent
5. æä¾›æ‰§è¡Œè¿›åº¦å’Œæœ€ç»ˆæ€»ç»“

### åœºæ™¯2: æ•°æ®åˆ†æé¡¹ç›®

**ç”¨æˆ·è¾“å…¥:**
```
æˆ‘éœ€è¦åˆ†æç”¨æˆ·è¡Œä¸ºæ•°æ®ï¼Œæ‰¾å‡ºæµå¤±åŸå› å¹¶æå‡ºæ”¹è¿›å»ºè®®
```

**PlanningAgentä¼š:**
1. è§„åˆ’ä»»åŠ¡ï¼šæ•°æ®æ”¶é›† â†’ æ•°æ®æ¸…æ´— â†’ ç»Ÿè®¡åˆ†æ â†’ å¯è§†åŒ– â†’ ç»“è®ºå»ºè®®
2. å°†æ•°æ®åˆ†æä»»åŠ¡å§”æ‰˜ç»™"åˆ†æä¸“å®¶"
3. è·Ÿè¸ªæ¯ä¸ªé˜¶æ®µçš„è¿›åº¦
4. æ•´åˆæ‰€æœ‰åˆ†æç»“æœå¹¶æ€»ç»“

### åœºæ™¯3: ä»£ç é‡æ„ä»»åŠ¡

**ç”¨æˆ·è¾“å…¥:**
```
é‡æ„ç°æœ‰çš„ç”¨æˆ·è®¤è¯æ¨¡å—ï¼Œæé«˜ä»£ç è´¨é‡å’Œå®‰å…¨æ€§
```

**PlanningAgentä¼š:**
1. è§„åˆ’ï¼šä»£ç å®¡æŸ¥ â†’ è¯†åˆ«é—®é¢˜ â†’ è®¾è®¡æ–¹æ¡ˆ â†’ å®ç°é‡æ„ â†’ æµ‹è¯•éªŒè¯
2. å§”æ‰˜"ç¼–ç¨‹åŠ©æ‰‹"æ‰§è¡ŒæŠ€æœ¯ä»»åŠ¡
3. ç®¡ç†æ•´ä¸ªé‡æ„æµç¨‹
4. ç¡®ä¿æ¯ä¸ªæ­¥éª¤éƒ½å®Œæˆåå†è¿›å…¥ä¸‹ä¸€æ­¥

## WebSocketäº‹ä»¶ç±»å‹

PlanningAgentä¼šå‘é€ä»¥ä¸‹ç‰¹æ®Šäº‹ä»¶ï¼š

### planning_start
ä»»åŠ¡è§„åˆ’å¼€å§‹
```json
{
    "type": "planning_start",
    "messageId": "msg_abc123",
    "phase": "analysis"
}
```

### planning_tasks
ä»»åŠ¡è®¡åˆ’ç”Ÿæˆå®Œæˆ
```json
{
    "type": "planning_tasks",
    "messageId": "msg_abc123",
    "tasks": [
        {
            "id": "task1",
            "title": "éœ€æ±‚åˆ†æ",
            "description": "...",
            "status": "pending",
            "priority": "high",
            "dependencies": [],
            "assigned_agent": "åˆ†æä¸“å®¶"
        }
    ],
    "progress": {
        "total": 5,
        "completed": 0,
        "in_progress": 0,
        "pending": 5,
        "failed": 0,
        "progress": 0
    }
}
```

### planning_task_start
å•ä¸ªä»»åŠ¡å¼€å§‹æ‰§è¡Œ
```json
{
    "type": "planning_task_start",
    "messageId": "msg_abc123",
    "task": { /* ä»»åŠ¡è¯¦æƒ… */ }
}
```

### planning_task_complete
å•ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆ
```json
{
    "type": "planning_task_complete",
    "messageId": "msg_abc123",
    "task": {
        "id": "task1",
        "status": "completed",
        "result": "ä»»åŠ¡æ‰§è¡Œç»“æœ..."
    }
}
```

### planning_progress
è¿›åº¦æ›´æ–°
```json
{
    "type": "planning_progress",
    "messageId": "msg_abc123",
    "progress": {
        "total": 5,
        "completed": 2,
        "in_progress": 1,
        "pending": 2,
        "failed": 0,
        "progress": 40
    },
    "current_task": { /* å½“å‰ä»»åŠ¡ */ }
}
```

## é…ç½®å‚æ•°

### åˆå§‹åŒ–å‚æ•°

```python
PlanningAgent(
    name="ä»»åŠ¡è§„åˆ’å¸ˆ",
    llm_client=llm_client,
    tool_registry=tool_registry,
    session_manager=session_manager,
    agent_manager=agent_manager,  # ç”¨äºå§”æ‰˜å…¶ä»–Agent
    max_iterations=20,  # æœ€å¤§ä»»åŠ¡æ‰§è¡Œæ¬¡æ•°
    system_prompt=custom_prompt  # è‡ªå®šä¹‰ç³»ç»Ÿæç¤ºè¯
)
```

### ä»»åŠ¡å±æ€§

- **id**: ä»»åŠ¡å”¯ä¸€æ ‡è¯†
- **title**: ä»»åŠ¡æ ‡é¢˜
- **description**: è¯¦ç»†æè¿°
- **status**: ä»»åŠ¡çŠ¶æ€ (pending/in_progress/completed/failed/blocked)
- **priority**: ä¼˜å…ˆçº§ (low/medium/high/critical)
- **dependencies**: ä¾èµ–çš„ä»»åŠ¡IDåˆ—è¡¨
- **assigned_agent**: å»ºè®®æ‰§è¡Œçš„Agentåç§°
- **result**: æ‰§è¡Œç»“æœ
- **error**: é”™è¯¯ä¿¡æ¯

## æœ€ä½³å®è·µ

### 1. ä»»åŠ¡æè¿°è¦æ¸…æ™°
```
å¥½çš„æè¿°ï¼šåˆ†æç”¨æˆ·æ³¨å†Œæµç¨‹ï¼Œæ‰¾å‡ºå¯¼è‡´ç”¨æˆ·æµå¤±çš„æ­¥éª¤
ä¸å¥½çš„æè¿°ï¼šä¼˜åŒ–ç³»ç»Ÿ
```

### 2. åˆç†è®¾ç½®ä¾èµ–å…³ç³»
```
éœ€æ±‚åˆ†æ â†’ æŠ€æœ¯é€‰å‹ â†’ æ¶æ„è®¾è®¡ â†’ åŠŸèƒ½å®ç° â†’ æµ‹è¯•
```

### 3. é€‚å½“çš„ä»»åŠ¡ç²’åº¦
- ä¸è¦å¤ªç²—ï¼šé¿å…å•ä¸ªä»»åŠ¡è¿‡äºå¤æ‚
- ä¸è¦å¤ªç»†ï¼šé¿å…ä»»åŠ¡è¿‡äºçç¢
- å»ºè®®ï¼šæ¯ä¸ªä»»åŠ¡æ§åˆ¶åœ¨10-30åˆ†é’Ÿå†…å®Œæˆ

### 4. å……åˆ†åˆ©ç”¨AgentååŒ
- æ•°æ®åˆ†æä»»åŠ¡ â†’ å§”æ‰˜ç»™"åˆ†æä¸“å®¶"
- ä»£ç å®ç°ä»»åŠ¡ â†’ å§”æ‰˜ç»™"ç¼–ç¨‹åŠ©æ‰‹"
- éœ€æ±‚æ¢³ç†ä»»åŠ¡ â†’ å§”æ‰˜ç»™"é€šç”¨åŠ©ç†"

## æŠ€æœ¯æ¶æ„

### æ ¸å¿ƒç»„ä»¶

1. **PlanningAgent**: ä¸»Agentç±»ï¼Œç»§æ‰¿è‡ªBaseAgent
2. **TaskManager**: ä»»åŠ¡ç®¡ç†å™¨ï¼Œè´Ÿè´£ä»»åŠ¡è°ƒåº¦
3. **Task**: ä»»åŠ¡æ•°æ®æ¨¡å‹
4. **TaskStatus**: ä»»åŠ¡çŠ¶æ€æšä¸¾
5. **TaskPriority**: ä»»åŠ¡ä¼˜å…ˆçº§æšä¸¾

### æ‰§è¡Œæµç¨‹

```
ç”¨æˆ·è¾“å…¥
  â†“
LLMè§„åˆ’ä»»åŠ¡
  â†“
ç”Ÿæˆä»»åŠ¡åˆ—è¡¨
  â†“
æ·»åŠ åˆ°TaskManager
  â†“
æŒ‰ä¾èµ–å…³ç³»å’Œä¼˜å…ˆçº§è°ƒåº¦
  â†“
æ‰§è¡Œä»»åŠ¡ï¼ˆå§”æ‰˜Agentæˆ–ç›´æ¥æ‰§è¡Œï¼‰
  â†“
æ›´æ–°çŠ¶æ€å’Œè¿›åº¦
  â†“
æ€»ç»“ç»“æœ
```

## æ³¨æ„äº‹é¡¹

1. **LLMè§£æ**: ä»»åŠ¡è®¡åˆ’ç”±LLMç”Ÿæˆï¼Œå¯èƒ½éœ€è¦å¤šæ¬¡è°ƒæ•´æç¤ºè¯ä»¥è·å¾—æœ€ä½³æ•ˆæœ
2. **ä¾èµ–æ£€æµ‹**: ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹å¾ªç¯ä¾èµ–ï¼Œé¿å…æ­»é”
3. **å¤±è´¥å¤„ç†**: å•ä¸ªä»»åŠ¡å¤±è´¥ä¸ä¼šä¸­æ–­æ•´ä¸ªæµç¨‹ï¼Œä¼šç»§ç»­æ‰§è¡Œå…¶ä»–ç‹¬ç«‹ä»»åŠ¡
4. **ä¼šè¯éš”ç¦»**: æ¯ä¸ªä¼šè¯çš„ä»»åŠ¡ç®¡ç†å™¨ç‹¬ç«‹ï¼Œä¸ä¼šç›¸äº’å½±å“
5. **èµ„æºæ¶ˆè€—**: å¤æ‚ä»»åŠ¡è§„åˆ’å¯èƒ½éœ€è¦è¾ƒå¤šLLMè°ƒç”¨ï¼Œæ³¨æ„æ§åˆ¶æˆæœ¬

## æ•…éšœæ’æŸ¥

### é—®é¢˜1: ä»»åŠ¡è®¡åˆ’ç”Ÿæˆå¤±è´¥
**åŸå› **: LLMè¿”å›çš„ä¸æ˜¯æœ‰æ•ˆJSONæ ¼å¼
**è§£å†³**: åœ¨ç”¨æˆ·è¾“å…¥ä¸­æä¾›æ›´æ¸…æ™°çš„ä»»åŠ¡æè¿°

### é—®é¢˜2: ä»»åŠ¡ä¸€ç›´å¤„äºPENDINGçŠ¶æ€
**åŸå› **: ä¾èµ–çš„ä»»åŠ¡æœªå®Œæˆæˆ–å­˜åœ¨å¾ªç¯ä¾èµ–
**è§£å†³**: æ£€æŸ¥ä»»åŠ¡ä¾èµ–å…³ç³»ï¼Œç¡®ä¿æ²¡æœ‰å¾ªç¯

### é—®é¢˜3: Agentå§”æ‰˜å¤±è´¥
**åŸå› **: æŒ‡å®šçš„Agentåç§°ä¸å­˜åœ¨
**è§£å†³**: ç¡®ä¿assigned_agentä½¿ç”¨æ­£ç¡®çš„Agentåç§°ï¼ˆé€šç”¨åŠ©ç†ã€åˆ†æä¸“å®¶ã€ç¼–ç¨‹åŠ©æ‰‹ã€ç®€å•å¯¹è¯ï¼‰

## ç¤ºä¾‹ä»£ç 

å®Œæ•´æµ‹è¯•ç¤ºä¾‹è¯·å‚è€ƒï¼š`test/test_planning_agent.py`

```python
# æŸ¥çœ‹æ‰€æœ‰Agent
import requests
agents = requests.get('http://localhost:8000/agent/info').json()
planning_agent = [a for a in agents if a['type'] == 'planning'][0]
print(planning_agent)
```

---

**PlanningAgent** - è®©å¤æ‚ä»»åŠ¡ç®¡ç†å˜å¾—ç®€å•ï¼ ğŸš€
